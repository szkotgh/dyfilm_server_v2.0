{% extends "admin/base.html" %}

{% block head %}
    <style>
        .table-content {
            margin: 1rem 6% 1rem 6%;
        }
    </style>
{% endblock head %}

{% block body %}
    <h4><a href="/admin">홈</a> | CapFrame 관리</h4>
    <p>값을 클릭해 수정하세요.<br><a href="/admin/config/capframe/create">CapFrame 수동 추가</a></p>
    <div class="table-content">
        <table class="table table-hover" id="capframe-table">
            <thead>
                <tr>
                    <th>
                        {% set modal_id = 'cf_id' %}
                        {% set display_text = 'cf_id' %}
                        {% set title = '캡프레임 아이디' %}
                        {% set message = '캡프레임마다 부여되는 고유한 ID입니다. 클릭하면 캡프레임을 삭제할 수 있습니다.' %}
                        {% include 'components/modals/view_message_modal.html' %}
                    </th>
                    <th>
                        {% set modal_id = 'd_id' %}
                        {% set display_text = 'd_id' %}
                        {% set title = '장치 아이디' %}
                        {% set message = '이 캡프레임을 생성한 장치의 아이디입니다. 관리자 페이지에서 수동 추가 시 NULL로 기록됩니다. 이 값은 수정할 수 없습니다.' %}
                        {% include 'components/modals/view_message_modal.html' %}
                    </th>
                    <th>
                        {% set modal_id = 'f_id' %}
                        {% set display_text = 'f_id' %}
                        {% set title = '프레임 아이디' %}
                        {% set message = '캡프레임이 생성될 때 사용된 프레임의 아이디입니다. 이 값은 수정할 수 없습니다.' %}
                        {% include 'components/modals/view_message_modal.html' %}
                    </th>
                    <th>
                        {% set modal_id = 'status' %}
                        {% set display_text = 'status' %}
                        {% set title = '캡프레임 상태' %}
                        {% set message = '캡프레임 공개 여부를 설정하는 항목입니다. 활성화하면 사진이 모든 장치와 사용자에게 보여지고, 비활성화하면 관리자만 볼 수 있습니다. 클릭해 토글 설정할 수 있습니다.' %}
                        {% include 'components/modals/view_message_modal.html' %}
                    </th>
                    <th>
                        {% set modal_id = 'file_name' %}
                        {% set display_text = 'file_name' %}
                        {% set title = '캡프레임 이미지' %}
                        {% set message = '서버에 저장되어있는 캡프레임 이미지의 실제 파일 이름입니다. 클릭하면 사진 열람과 사진 변경이 가능합니다.' %}
                        {% include 'components/modals/view_message_modal.html' %}
                    </th>
                    <th>
                        {% set modal_id = 'desc' %}
                        {% set display_text = 'desc' %}
                        {% set title = '캡프레임 설명' %}
                        {% set message = '캡프레임의 비고란입니다. 클릭해 기록·수정할 수 있습니다.' %}
                        {% include 'components/modals/view_message_modal.html' %}
                    </th>
                    <th>
                        {% set modal_id = 'create' %}
                        {% set display_text = 'create' %}
                        {% set title = '캡프레임 생성 날짜' %}
                        {% set message = '캡프레임 항목이 생성된 날짜입니다. 이 값은 수정할 수 없습니다.' %}
                        {% include 'components/modals/view_message_modal.html' %}
                    </th>
                    <th>
                        {% set modal_id = 'processing_time' %}
                        {% set display_text = 'processing_time' %}
                        {% set title = '캡프레임 처리 시간' %}
                        {% set message = '캡프레임 이미지가 생성되는데 걸린 시간입니다. 이 값은 수정할 수 없습니다.' %}
                        {% include 'components/modals/view_message_modal.html' %}
                    </th>
                </tr>
            </thead>
            <tbody class="table-group-divider" id="capframe-tbody">
                <tr>
                    <td colspan="8" style="text-align: center;">로딩 중...</td>
                </tr>
            </tbody>
        </table>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tbody = document.getElementById('capframe-tbody');
            const loadMoreButton = document.createElement('button');
            loadMoreButton.className = 'btn btn-outline-secondary';
            loadMoreButton.textContent = '더 불러오기';
            loadMoreButton.style.display = 'none';
            const container = document.querySelector('.table-content');
            const footerDiv = document.createElement('div');
            footerDiv.style.textAlign = 'center';
            footerDiv.style.margin = '1rem 0';
            const counterSpan = document.createElement('span');
            counterSpan.style.marginLeft = '12px';
            counterSpan.style.color = '#6c757d';
            footerDiv.appendChild(loadMoreButton);
            footerDiv.appendChild(counterSpan);
            container.appendChild(footerDiv);

            const state = { limit: 30, offset: 0, loading: false, done: false };

            function updateCounter(shown, total) {
                counterSpan.textContent = `${shown}/${total}`;
            }

            async function fetchTotal() {
                try {
                    const res = await fetch(`{{ url_for('router.admin.config.capframe.get_count') }}`);
                    const json = await res.json();
                    return typeof json.total === 'number' ? json.total : 0;
                } catch (_) {
                    return 0;
                }
            }

            async function loadRows() {
                if (state.loading || state.done) return;
                state.loading = true;
                try {
                    const params = new URLSearchParams({ limit: String(state.limit), offset: String(state.offset) });
                    const response = await fetch(`{{ url_for('router.admin.config.capframe.get_list') }}?${params.toString()}`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                    const data = await response.json();
                    const items = Array.isArray(data.items) ? data.items : [];

                    if (state.offset === 0) tbody.innerHTML = '';

                    for (const item of items) {
                        const tr = document.createElement('tr');
                        tr.setAttribute('data-row', 'capframe');
                        tr.innerHTML = `
                            <td>
                                <span style="cursor: pointer;" data-bs-toggle="modal" data-bs-target="#cf_id${item.cf_id}">${item.cf_id}</span>
                                <div class="modal fade" id="cf_id${item.cf_id}" tabindex="-1" aria-hidden="true"><div class="modal-dialog"><div class="modal-content">
                                  <div class="modal-header"><h5 class="modal-title">캡프레임 삭제</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
                                  <form action="{{ url_for('router.admin.config.capframe.remove') }}" method="post">
                                    <div class="modal-body"><p>캡프레임 ${item.cf_id}을 삭제하시겠습니까? 되돌릴 수 없습니다.</p><input type="hidden" name="cf_id" value="${item.cf_id}"></div>
                                    <div class="modal-footer"><button type="submit" class="btn btn-primary">네</button><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">아니오</button></div>
                                  </form>
                                </div></div></div>
                        </td>
                        <td>
                                <span style="cursor: pointer;" data-bs-toggle="modal" data-bs-target="#d_id${item.cf_id}">${item.d_id ?? ''}</span>
                                <div class="modal fade" id="d_id${item.cf_id}" tabindex="-1" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">장치 아이디</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body"><p>이 값은 수정할 수 없습니다.</p></div><div class="modal-footer"><button type="button" class="btn btn-primary" data-bs-dismiss="modal">확인</button></div></div></div></div>
                        </td>
                        <td>
                                <span style="cursor: pointer;" data-bs-toggle="modal" data-bs-target="#f_id${item.cf_id}">${item.f_id ?? ''}</span>
                                <div class="modal fade" id="f_id${item.cf_id}" tabindex="-1" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">프레임 아이디</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body"><p>이 값은 수정할 수 없습니다.</p></div><div class="modal-footer"><button type="button" class="btn btn-primary" data-bs-dismiss="modal">확인</button></div></div></div></div>
                        </td>
                        <td>
                                <span style="cursor: pointer;" data-bs-toggle="modal" data-bs-target="#status${item.cf_id}">${item.status ? '활성화' : '비활성화'}</span>
                                <div class="modal fade" id="status${item.cf_id}" tabindex="-1" aria-hidden="true"><div class="modal-dialog"><div class="modal-content">
                                  <div class="modal-header"><h5 class="modal-title">캡프레임 상태 변경</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
                                  <form action="{{ url_for('router.admin.config.capframe.config_status') }}" method="post">
                                    <div class="modal-body"><p>캡프레임 ${item.cf_id}의 상태를 변경하시겠습니까?</p><input type="hidden" name="cf_id" value="${item.cf_id}"></div>
                                    <div class="modal-footer"><button type="submit" class="btn btn-primary">네</button><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">아니오</button></div>
                                  </form>
                                </div></div></div>
                        </td>
                        <td>
                                <span style="cursor: pointer;" data-bs-toggle="modal" data-bs-target="#file_name${item.cf_id}">${item.file_name}</span>
                                <div class="modal fade" id="file_name${item.cf_id}" tabindex="-1" aria-hidden="true"><div class="modal-dialog"><div class="modal-content">
                                  <div class="modal-header"><h5 class="modal-title">캡프레임 이미지</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
                                  <div class="modal-body text-center"><img id="modalImagefile_name${item.cf_id}" data-src="${item.image_url}" src="" class="img-fluid" loading="lazy" decoding="async" onerror="this.onerror=null;this.src='{{ url_for('static', filename='images/loading.gif') }}';"></div>
                                  <div class="modal-body"><a href="https://film.dyhs.kr/view/capframe/${item.cf_id}" target="_blank">이미지 열람</a><p>이 이미지는 변경할 수 없습니다.</p></div>
                                  <div class="modal-footer"><button type="button" class="btn btn-primary" data-bs-dismiss="modal">확인</button></div>
                                </div></div></div>
                        </td>
                        <td>
                                <span style="cursor: pointer;" data-bs-toggle="modal" data-bs-target="#desc${item.cf_id}">${(item.desc ?? '') || 'NULL'}</span>
                                <div class="modal fade" id="desc${item.cf_id}" tabindex="-1" aria-hidden="true"><div class="modal-dialog"><div class="modal-content">
                                  <div class="modal-header"><h5 class="modal-title">캡프레임 설명 수정</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
                                  <form action="{{ url_for('router.admin.config.capframe.config_desc') }}" method="post">
                                    <div class="modal-body"><p>캡프레임 ${item.cf_id}의 설명을 수정하시겠습니까?</p><input type="hidden" name="cf_id" value="${item.cf_id}"><input type="text" class="form-control" name="config_desc" value="${item.desc ?? ''}"></div>
                                    <div class="modal-footer"><button type="submit" class="btn btn-primary">저장</button><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button></div>
                                  </form>
                                </div></div></div>
                        </td>
                        <td>
                                <span style="cursor: pointer;" data-bs-toggle="modal" data-bs-target="#create${item.cf_id}">${item.create}</span>
                                <div class="modal fade" id="create${item.cf_id}" tabindex="-1" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">캡프레임 생성 날짜</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body"><p>이 값은 수정할 수 없습니다.</p></div><div class="modal-footer"><button type="button" class="btn btn-primary" data-bs-dismiss="modal">확인</button></div></div></div></div>
                        </td>
                        <td>
                                <span style="cursor: pointer;" data-bs-toggle="modal" data-bs-target="#processing${item.cf_id}">${item.processing_time}초</span>
                                <div class="modal fade" id="processing${item.cf_id}" tabindex="-1" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">캡프레임 처리 시간</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body"><p>이 값은 수정할 수 없습니다.</p></div><div class="modal-footer"><button type="button" class="btn btn-primary" data-bs-dismiss="modal">확인</button></div></div></div></div>
                        </td>
                        `;
                        tbody.appendChild(tr);
                        const modalEl = document.getElementById(`file_name${item.cf_id}`);
                        if (modalEl) {
                            modalEl.addEventListener('show.bs.modal', () => {
                                const img = document.getElementById(`modalImagefile_name${item.cf_id}`);
                                if (img && !img.getAttribute('src')) img.src = img.dataset.src;
                            });
                        }
                    }

                    if (items.length < state.limit) state.done = true;
                    state.offset += items.length;
                    loadMoreButton.style.display = state.done ? 'none' : 'inline-block';

                    const total = await fetchTotal();
                    const shown = tbody.querySelectorAll('tr[data-row="capframe"]').length;
                    updateCounter(shown, total);
                } catch (e) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">불러오기 실패</td></tr>';
                    state.done = true;
                } finally {
                    state.loading = false;
                    if (!state.done) loadMoreButton.style.display = 'inline-block';
                }
            }

            loadMoreButton.addEventListener('click', () => loadRows());

            // initial load
            (async () => {
                const total = await fetchTotal();
                updateCounter(0, total);
                loadRows();
            })();
        });
    </script>
{% endblock body %}
