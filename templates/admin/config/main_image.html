{% extends "admin/base.html" %}

{% block head %}
    <style>
        .table-content {
            margin: 1rem 3% 1rem 3%;
        }
    </style>
{% endblock head %}

{% block body %}
    <h4><a href="/admin">홈</a> | Main Image 관리</h4>
    <p>값을 클릭해 수정하세요.<br>
    <text class="text-primary" style="cursor: pointer;" data-bs-toggle="modal" data-bs-target="#createModal">Main Image 추가</text></p>
    
    <!-- Main Image 추가 모달 -->
    <div class="modal fade" id="createModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Main Image 추가</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="post" action="{{ url_for('router.admin.config.main_image.create') }}" enctype="multipart/form-data">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">이미지 파일 <span class="text-danger">*</span></label>
                            <input type="file" class="form-control" name="main_image_file" accept=".gif,.png,.jpg,.jpeg" required>
                            <small class="form-text text-muted">gif, png, jpg, jpeg 파일만 허용됩니다.</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">설명</label>
                            <input type="text" class="form-control" name="desc" placeholder="파일 식별용 설명을 입력하세요">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">추가</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="table-content">
        <table class="table table-hover" id="main_image-table">
            <thead>
                <tr>
                    <th>
                        {% set modal_id = 'mi_id' %}
                        {% set display_text = 'mi_id' %}
                        {% set title = 'Main Image 아이디' %}
                        {% set message = 'Main Image마다 부여되는 고유한 ID입니다. 클릭하면 Main Image를 삭제할 수 있습니다.' %}
                        {% include 'components/modals/view_message_modal.html' %}
                    </th>
                    <th>
                        {% set modal_id = 'file_name' %}
                        {% set display_text = 'file_name' %}
                        {% set title = '파일 이름' %}
                        {% set message = '서버에 저장되어있는 Main Image의 실제 파일 이름입니다. 클릭하면 이미지 열람과 이미지 변경이 가능합니다.' %}
                        {% include 'components/modals/view_message_modal.html' %}
                    </th>
                    <th>
                        {% set modal_id = 'desc' %}
                        {% set display_text = 'desc' %}
                        {% set title = '설명' %}
                        {% set message = 'Main Image의 비고란입니다. 관리자가 파일을 식별하는 용도로 사용됩니다. 클릭해 기록·수정할 수 있습니다.' %}
                        {% include 'components/modals/view_message_modal.html' %}
                    </th>
                    <th>
                        {% set modal_id = 'is_default' %}
                        {% set display_text = 'is_default' %}
                        {% set title = '기본 이미지' %}
                        {% set message = '전역 기본 이미지 설정입니다. 하나만 기본 이미지로 설정할 수 있으며, 장치별 설정이 없을 때 사용됩니다. 클릭해 설정할 수 있습니다.' %}
                        {% include 'components/modals/view_message_modal.html' %}
                    </th>
                    <th>
                        {% set modal_id = 'default_device_id' %}
                        {% set display_text = 'default_device_id' %}
                        {% set title = '장치별 기본 이미지' %}
                        {% set message = '특정 장치에 개별적으로 설정하는 Main Image입니다. 해당 장치가 이 이미지를 우선적으로 사용합니다. 클릭해 설정할 수 있습니다.' %}
                        {% include 'components/modals/view_message_modal.html' %}
                    </th>
                    <th>
                        {% set modal_id = 'create' %}
                        {% set display_text = 'create' %}
                        {% set title = '생성 날짜' %}
                        {% set message = 'Main Image 항목이 생성된 날짜입니다. 이 값은 수정할 수 없습니다.' %}
                        {% include 'components/modals/view_message_modal.html' %}
                    </th>
                </tr>
            </thead>
            <tbody class="table-group-divider" id="main_image-tbody">
                <tr>
                    <td colspan="6" style="text-align: center;">로딩 중...</td>
                </tr>
            </tbody>
        </table>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tbody = document.getElementById('main_image-tbody');
            const table = document.getElementById('main_image-table');
            const container = table.closest('.table-content');
            const footerDiv = document.createElement('div');
            footerDiv.style.textAlign = 'center';
            footerDiv.style.margin = '1rem 0';
            const loadMoreButton = document.createElement('button');
            loadMoreButton.className = 'btn btn-outline-secondary';
            loadMoreButton.textContent = '더 불러오기';
            loadMoreButton.style.display = 'none';
            const counterSpan = document.createElement('span');
            counterSpan.style.marginLeft = '12px';
            counterSpan.style.color = '#6c757d';
            footerDiv.appendChild(loadMoreButton);
            footerDiv.appendChild(counterSpan);
            container.appendChild(footerDiv);

            const state = { limit: 30, offset: 0, loading: false, done: false };
            let devicesCache = null;

            function updateCounter(shown, total) { counterSpan.textContent = `${shown}/${total}`; }

            async function fetchTotal() {
                try { const res = await fetch(`{{ url_for('router.admin.config.main_image.get_count') }}`); const json = await res.json(); return typeof json.total === 'number' ? json.total : 0; } catch { return 0; }
            }

            async function fetchDevices() {
                if (devicesCache) return devicesCache;
                try {
                    const res = await fetch(`{{ url_for('router.admin.config.main_image.device_list') }}`);
                    const json = await res.json();
                    devicesCache = Array.isArray(json.items) ? json.items : [];
                    return devicesCache;
                } catch {
                    return [];
                }
            }

            async function loadRows() {
                if (state.loading || state.done) return; state.loading = true;
                try {
                    const params = new URLSearchParams({ limit: String(state.limit), offset: String(state.offset) });
                    const response = await fetch(`{{ url_for('router.admin.config.main_image.get_list') }}?${params.toString()}`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                    const data = await response.json();
                    const items = Array.isArray(data.items) ? data.items : [];
                    if (state.offset === 0) { tbody.innerHTML = ''; }
                    const devices = await fetchDevices();
                    for (const item of items) {
                        const tr = document.createElement('tr');
                        tr.setAttribute('data-row', 'main_image');
                        
                        const deviceNames = item.device_ids && item.device_ids.length > 0 ?
                            item.device_ids.map(d_id => {
                                const device = devices.find(d => d.d_id === d_id);
                                return device ? (device.desc || `장치 #${d_id}`) : `장치 #${d_id}`;
                            }).join(', ') : 
                            '없음';
                        
                        tr.innerHTML = `
                            <td>
                                <span style="cursor:pointer;" data-bs-toggle="modal" data-bs-target="#remove${item.mi_id}">${item.mi_id}</span>
                                <div class="modal fade" id="remove${item.mi_id}" tabindex="-1" aria-hidden="true"><div class="modal-dialog"><div class="modal-content">
                                  <div class="modal-header"><h5 class="modal-title">Main Image 삭제</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
                                  <form action="{{ url_for('router.admin.config.main_image.remove') }}" method="post">
                                    <div class="modal-body"><p>Main Image ${item.mi_id}을 삭제하시겠습니까? 되돌릴 수 없습니다.</p><input type="hidden" name="mi_id" value="${item.mi_id}"></div>
                                    <div class="modal-footer"><button type="submit" class="btn btn-primary">네</button><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">아니오</button></div>
                                  </form>
                                </div></div></div>
                            </td>
                            <td>
                                <span style="cursor:pointer;" data-bs-toggle="modal" data-bs-target="#image${item.mi_id}">${item.file_name}</span>
                                <div class="modal fade" id="image${item.mi_id}" tabindex="-1" aria-hidden="true"><div class="modal-dialog modal-lg"><div class="modal-content">
                                  <div class="modal-header"><h5 class="modal-title">Main Image 열람·변경</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
                                  <div class="modal-body text-center"><img id="modalImageimage${item.mi_id}" data-src="${item.image_url}" src="{{ url_for('static', filename='images/loading.gif') }}" class="img-fluid" loading="lazy" decoding="async" onerror="this.onerror=null;this.src='{{ url_for('static', filename='images/loading.gif') }}';" style="max-height: 500px;"></div>
                                  <div class="modal-body">
                                    <form method="post" action="{{ url_for('router.admin.config.main_image.config_image') }}" enctype="multipart/form-data">
                                      <input type="hidden" name="mi_id" value="${item.mi_id}">
                                      <div class="mb-3 text-start">
                                        <label class="form-label">이미지 선택 <span class="text-danger">*</span></label>
                                        <input type="file" class="form-control" name="config_image" accept=".gif,.png,.jpg,.jpeg" required>
                                        <small class="form-text text-muted">gif, png, jpg, jpeg 파일만 허용됩니다.</small>
                                      </div>
                                      <button type="submit" class="btn btn-success">이미지 변경</button>
                                    </form>
                                  </div>
                                  <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button></div>
                                </div></div></div>
                            </td>
                            <td>
                                <span style="cursor:pointer;" data-bs-toggle="modal" data-bs-target="#desc${item.mi_id}">${(item.desc ?? '') || 'NULL'}</span>
                                <div class="modal fade" id="desc${item.mi_id}" tabindex="-1" aria-hidden="true"><div class="modal-dialog"><div class="modal-content">
                                  <div class="modal-header"><h5 class="modal-title">설명 수정</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
                                  <form action="{{ url_for('router.admin.config.main_image.config_desc') }}" method="post">
                                    <div class="modal-body"><input type="hidden" name="mi_id" value="${item.mi_id}"><input type="text" class="form-control" name="config_desc" value="${item.desc ?? ''}"></div>
                                    <div class="modal-footer"><button type="submit" class="btn btn-primary">저장</button><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button></div>
                                  </form>
                                </div></div></div>
                            </td>
                            <td>
                                ${item.is_default ? 
                                    `<span style="cursor:pointer;" data-bs-toggle="modal" data-bs-target="#isdefault${item.mi_id}" class="text-success fw-bold">기본 이미지</span>
                                    <div class="modal fade" id="isdefault${item.mi_id}" tabindex="-1" aria-hidden="true"><div class="modal-dialog"><div class="modal-content">
                                      <div class="modal-header"><h5 class="modal-title">기본 이미지 해제</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
                                      <form action="{{ url_for('router.admin.config.main_image.unset_default') }}" method="post">
                                        <div class="modal-body"><p>Main Image ${item.mi_id}의 기본 이미지 설정을 해제하시겠습니까? 해제 후에는 장치별 설정이 없는 장치들이 기본 이미지를 사용할 수 없게 됩니다.</p></div>
                                        <div class="modal-footer"><button type="submit" class="btn btn-primary">해제</button><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button></div>
                                      </form>
                                    </div></div></div>` : 
                                    `<span style="cursor:pointer;" data-bs-toggle="modal" data-bs-target="#isdefault${item.mi_id}">설정하기</span>
                                    <div class="modal fade" id="isdefault${item.mi_id}" tabindex="-1" aria-hidden="true"><div class="modal-dialog"><div class="modal-content">
                                      <div class="modal-header"><h5 class="modal-title">기본 이미지 설정</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
                                      <form action="{{ url_for('router.admin.config.main_image.config_is_default') }}" method="post">
                                        <div class="modal-body"><p>Main Image ${item.mi_id}을 기본 이미지로 설정하시겠습니까? 기존 기본 이미지는 해제됩니다.</p><input type="hidden" name="mi_id" value="${item.mi_id}"></div>
                                        <div class="modal-footer"><button type="submit" class="btn btn-primary">네</button><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">아니오</button></div>
                                      </form>
                                    </div></div></div>`
                                }
                            </td>
                            <td>
                                <span style="cursor:pointer;" data-bs-toggle="modal" data-bs-target="#device${item.mi_id}">${deviceNames}</span>
                                <div class="modal fade" id="device${item.mi_id}" tabindex="-1" aria-hidden="true"><div class="modal-dialog"><div class="modal-content">
                                  <div class="modal-header"><h5 class="modal-title">장치별 기본 이미지 설정</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
                                  <form action="{{ url_for('router.admin.config.main_image.config_devices') }}" method="post">
                                    <div class="modal-body">
                                      <input type="hidden" name="mi_id" value="${item.mi_id}">
                                      <label class="form-label">장치 선택</label>
                                      <div class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                                        ${devices.map(d => `
                                          <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="device_ids" value="${d.d_id}" id="device_${item.mi_id}_${d.d_id}" ${item.device_ids && item.device_ids.includes(d.d_id) ? 'checked' : ''}>
                                            <label class="form-check-label" for="device_${item.mi_id}_${d.d_id}">
                                              ${d.desc || `장치 #${d.d_id}`} ${d.status ? '' : '<span class="text-muted">(비활성)</span>'}
                                            </label>
                                          </div>
                                        `).join('')}
                                      </div>
                                      <small class="form-text text-muted">선택한 장치들이 이 이미지를 우선적으로 사용합니다.</small>
                                    </div>
                                    <div class="modal-footer"><button type="submit" class="btn btn-primary">저장</button><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button></div>
                                  </form>
                                </div></div></div>
                            </td>
                            <td>
                                <span style="cursor:pointer;" data-bs-toggle="modal" data-bs-target="#create${item.mi_id}">${item.create}</span>
                                <div class="modal fade" id="create${item.mi_id}" tabindex="-1" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">생성 날짜</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body"><p>이 값은 수정할 수 없습니다.</p></div><div class="modal-footer"><button type="button" class="btn btn-primary" data-bs-dismiss="modal">확인</button></div></div></div></div>
                            </td>
                        `;
                        tbody.appendChild(tr);
                        const modalEl = document.getElementById(`image${item.mi_id}`);
                        if (modalEl) {
                            modalEl.addEventListener('show.bs.modal', () => {
                                const img = document.getElementById(`modalImageimage${item.mi_id}`);
                                if (img) img.src = img.dataset.src;
                            });
                            modalEl.addEventListener('hidden.bs.modal', () => {
                                const img = document.getElementById(`modalImageimage${item.mi_id}`);
                                if (img) img.src = `{{ url_for('static', filename='images/loading.gif') }}`;
                            });
                        }
                    }
                    if (items.length < state.limit) state.done = true; state.offset += items.length; loadMoreButton.style.display = state.done ? 'none' : 'inline-block';
                    const total = await fetchTotal(); const shown = tbody.querySelectorAll('tr[data-row="main_image"]').length; updateCounter(shown, total);
                } catch (e) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">불러오기 실패</td></tr>'; state.done = true;
                } finally { state.loading = false; if (!state.done) loadMoreButton.style.display = 'inline-block'; }
            }

            loadMoreButton.addEventListener('click', () => loadRows());
            (async () => { const total = await fetchTotal(); updateCounter(0, total); loadRows(); })();
        });
    </script>
{% endblock body %}
