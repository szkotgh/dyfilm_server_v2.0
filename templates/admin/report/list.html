{% extends "admin/base.html" %}

{% block head %}
<style>
    .table-content {
        margin: 1rem 6% 1rem 6%;
    }
    
    .report-status {
        display: inline-block;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .status-pending {
        background: rgb(179, 179, 179);
        color: white;
    }
    
    .status-approved {
        background: rgb(48, 160, 74);
        color: white;
    }
    
    .status-rejected {
        background: rgb(190, 42, 56);
        color: white;
    }
    
    .btn-approve {
        background: #28a745;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.3s;
    }
    
    .btn-approve:hover {
        background: #218838;
    }
    
    .btn-reject {
        background: #dc3545;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.3s;
    }
    
    .btn-reject:hover {
        background: #c82333;
    }
    
    .btn-disabled {
        background: #6c757d;
        cursor: not-allowed;
    }
    
    .btn-disabled:hover {
        background: #6c757d;
    }
    
    .report-reason {
        max-width: 300px;
        word-wrap: break-word;
    }
    
    .report-time {
        font-size: 14px;
        color: #666;
    }
    
    .report-ip {
        font-family: monospace;
        font-size: 12px;
        color: #666;
    }
</style>
{% endblock %}

{% block body %}
<h4><a href="/admin">홈</a> | CapFrame 비공개 처리 요청 확인</h4>
<div class="table-content">
    <table class="table table-hover" id="report-table">
        <thead>
            <tr>
                <th>
                    {% set modal_id = 'report_id' %}
                    {% set display_text = 'report_id' %}
                    {% set title = '요청 ID' %}
                    {% set message = '요청 ID입니다. 이 값은 수정할 수 없습니다.' %}
                    {% include 'components/modals/view_message_modal.html' %}
                </th>
                <th>
                    {% set modal_id = 'cf_id' %}
                    {% set display_text = 'cf_id' %}
                    {% set title = 'CapFrame ID' %}
                    {% set message = '비공개 처리 요청된 CapFrame ID입니다. 클릭해 이미지를 확인할 수 있습니다. 이 값은 수정할 수 없습니다.' %}
                    {% include 'components/modals/view_message_modal.html' %}
                </th>
                <th>
                    {% set modal_id = 'reason' %}
                    {% set display_text = 'reason' %}
                    {% set title = '요청 사유' %}
                    {% set message = '비공개 처리 요청 사유입니다. 이 값은 수정할 수 없습니다.' %}
                    {% include 'components/modals/view_message_modal.html' %}
                </th>
                <th>
                    {% set modal_id = 'reporter_ip' %}
                    {% set display_text = 'reporter_ip' %}
                    {% set title = '요청 IP' %}
                    {% set message = '비공개 처리 요청자의 IP입니다. 이 값은 수정할 수 없습니다.' %}
                    {% include 'components/modals/view_message_modal.html' %}
                </th>
                <th>
                    {% set modal_id = 'report_time' %}
                    {% set display_text = 'report_time' %}
                    {% set title = '요청 시간' %}
                    {% set message = '요청이 접수된 시간입니다. 이 값은 수정할 수 없습니다.' %}
                    {% include 'components/modals/view_message_modal.html' %}
                </th>
                <th>
                    {% set modal_id = 'status' %}
                    {% set display_text = 'status' %}
                    {% set title = '상태' %}
                    {% set message = '비공개 처리 요청의 처리 상태입니다. 이 값은 수정할 수 없습니다.' %}
                    {% include 'components/modals/view_message_modal.html' %}
                </th>
                <th>
                    {% set modal_id = 'admin_review_time' %}
                    {% set display_text = 'admin_review_time' %}
                    {% set title = '관리자 처리' %}
                    {% set message = '관리자가 요청을 처리한 시간입니다. 처리를 하지 않았을 경우 처리 메뉴 버튼이 표시됩니다. 이 값은 수정할 수 없습니다.' %}
                    {% include 'components/modals/view_message_modal.html' %}
                </th>
            </tr>
        </thead>
        <tbody class="table-group-divider" id="report-tbody">
            <tr>
                <td colspan="7" style="text-align: center;">로딩 중...</td>
            </tr>
        </tbody>
    </table>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const tbody = document.getElementById('report-tbody');
        const container = document.querySelector('.table-content');
        const footerDiv = document.createElement('div');
        footerDiv.style.textAlign = 'center';
        footerDiv.style.margin = '1rem 0';
        const loadMoreButton = document.createElement('button');
        loadMoreButton.className = 'btn btn-outline-secondary';
        loadMoreButton.textContent = '더 불러오기';
        loadMoreButton.style.display = 'none';
        const counterSpan = document.createElement('span');
        counterSpan.style.marginLeft = '12px';
        counterSpan.style.color = '#6c757d';
        footerDiv.appendChild(loadMoreButton);
        footerDiv.appendChild(counterSpan);
        container.appendChild(footerDiv);

        const state = { limit: 30, offset: 0, loading: false, done: false };

        function updateCounter(shown, total) { 
            counterSpan.textContent = `${shown}/${total}`; 
        }

        async function fetchTotal() {
            try { 
                const res = await fetch(`{{ url_for('router.admin.report_manage.report_count_ajax') }}`); 
                const json = await res.json(); 
                return typeof json.total === 'number' ? json.total : 0; 
            } catch { 
                return 0; 
            }
        }

        async function loadRows() {
            if (state.loading || state.done) return; 
            state.loading = true;
            try {
                const params = new URLSearchParams({ 
                    limit: String(state.limit), 
                    offset: String(state.offset) 
                });
                const response = await fetch(`{{ url_for('router.admin.report_manage.report_list_ajax') }}?${params.toString()}`, { 
                    headers: { 'X-Requested-With': 'XMLHttpRequest' } 
                });
                const data = await response.json();
                const items = Array.isArray(data.items) ? data.items : [];
                
                if (state.offset === 0) { 
                    tbody.innerHTML = ''; 
                }
                
                for (const item of items) {
                    const tr = document.createElement('tr'); 
                    tr.setAttribute('data-row', 'report');
                    
                    // 상태에 따른 버튼 렌더링
                    let actionButtons = '';
                    if (item.is_approved === null) {
                        actionButtons = `
                            <form method="POST" action="/admin/report/${item.report_id}/approve" style="display: inline;">
                                <button type="submit" class="btn-approve" onclick="return confirm('요청을 승인하시겠습니까?\n해당 CapFrame은 비활성화 처리됩니다.')">
                                    승인
                                </button>
                            </form>
                            <form method="POST" action="/admin/report/${item.report_id}/reject" style="display: inline;">
                                <button type="submit" class="btn-reject" onclick="return confirm('요청을 반려하시겠습니까?')">
                                    반려
                                </button>
                            </form>
                        `;
                    } else {
                        actionButtons = `<span class="report-time">${item.admin_review_time || ''}</span>`;
                    }
                    
                    // 상태 표시
                    let statusDisplay = '';
                    if (item.is_approved === null) {
                        statusDisplay = '<span class="report-status status-pending">대기중</span>';
                    } else if (item.is_approved == 1) {
                        statusDisplay = '<span class="report-status status-approved">승인됨</span>';
                    } else {
                        statusDisplay = '<span class="report-status status-rejected">반려됨</span>';
                    }
                    
                    tr.innerHTML = `
                        <td>#${item.report_id}</td>
                        <td>
                            <span style="cursor:pointer;" data-bs-toggle="modal" data-bs-target="#capframe${item.report_id}">${item.cf_id}</span>
                            <div class="modal fade" id="capframe${item.report_id}" tabindex="-1" aria-hidden="true">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">캡프레임 이미지</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body text-center">
                                            <img src="/view/capframe/${item.cf_id}/image" alt="CapFrame" style="max-width: 100%; height: auto;" 
                                                 onerror="this.src='/static/images/loading.gif'">
                                            <p class="mt-3 text-muted">이 이미지는 변경할 수 없습니다.</p>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <br>
                            <small class="report-time">촬영시각: ${item.capframe_create_time || 'N/A'}</small>
                        </td>
                        <td class="report-reason">${item.reason}</td>
                        <td class="report-ip">${item.reporter_ip}</td>
                        <td class="report-time">${item.report_time}</td>
                        <td>${statusDisplay}</td>
                        <td>${actionButtons}</td>
                    `;
                    tbody.appendChild(tr);
                }
                
                if (items.length < state.limit) state.done = true; 
                state.offset += items.length; 
                loadMoreButton.style.display = state.done ? 'none' : 'inline-block';
                
                const total = await fetchTotal(); 
                const shown = tbody.querySelectorAll('tr[data-row="report"]').length; 
                updateCounter(shown, total);
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">불러오기 실패</td></tr>'; 
                state.done = true;
            } finally { 
                state.loading = false; 
                if (!state.done) loadMoreButton.style.display = 'inline-block'; 
            }
        }

        loadMoreButton.addEventListener('click', () => loadRows());
        (async () => { 
            const total = await fetchTotal(); 
            updateCounter(0, total); 
            loadRows(); 
        })();
    });
</script>
{% endblock %}
